<wxs src="./attachments.wxs" module="_this" />
<wxs src="../../../components/common/utils.wxs" module="_" />

<!-- 图片文件模板 -->
<template name="image-item">
  <view class="file-image {{classPrefix}}__file {{removable ? classPrefix + '__file--removable' : ''}}">
    <block wx:if="{{item.status==='pending' || item.status==='fail' || item.status==='error'}}">
      <view class="{{item.status}} {{classPrefix}}__file--{{item.status}}">
        <t-loading theme="{{isSkyline ? 'spinner' : 'circular'}}" size="48rpx" />
      </view>
    </block>
    <block wx:else>
      <image
        class="image"
        src="{{item.url}}"
        mode="{{_this.getImageMode(item)}}"
        lazy-load="false"
        style="{{inChat ? _this.imageStyle(item) : ''}}"
        bindload="onImageLoad"
      ></image>
    </block>
    <view wx:if="{{removable}}" class="{{classPrefix}}__remove">
      <t-icon data-index="{{index}}" name="multiply" size="16px" catchtap="onRemoveTap" />
    </view>
  </view>
</template>

<!-- 普通文件模板 -->
<template name="file-item">
  <view class="file {{classPrefix}}__file {{removable ? classPrefix + '__file--removable' : ''}}">
    <view class="image">
      <block wx:if="{{item.status==='pending'}}">
        <view class="loading {{classPrefix}}__file--pending">
          <t-loading theme="{{isSkyline ? 'spinner' : 'circular'}}" size="48rpx" />
        </view>
      </block>
      <block wx:elif="{{item.status==='fail'}}">
        <view class="fail {{classPrefix}}__file--fail">
          <t-loading theme="{{isSkyline ? 'spinner' : 'circular'}}" size="48rpx" />
        </view>
      </block>
      <block wx:elif="{{item.status==='error'}}">
        <view class="error {{classPrefix}}__file--error">
          <t-loading theme="{{isSkyline ? 'spinner' : 'circular'}}" size="48rpx" />
        </view>
      </block>
      <block wx:else>
        <t-icon name="{{item.fileIcon.name}}" color="{{item.fileIcon.color}}" size="48rpx"></t-icon>
      </block>
    </view>
    <view class="{{classPrefix}}__content">
      <view class="{{classPrefix}}__title">{{item.name}}</view>
      <view wx:if="{{item.status==='pending'}}" class="{{classPrefix}}__desc">上传中...{{item.progress || 0+"%"}}</view>
      <view wx:elif="{{item.status==='fail'}}" class="{{classPrefix}}__desc">上传失败</view>
      <view wx:elif="{{item.status==='error'}}" class="{{classPrefix}}__desc">{{item.errorMessage}}</view>
      <view wx:else class="{{classPrefix}}__desc">{{item.desc}}</view>
    </view>
    <view wx:if="{{removable}}" class="{{classPrefix}}__remove">
      <t-icon data-index="{{index}}" name="multiply" size="16px" catchtap="onRemoveTap" />
    </view>
  </view>
</template>

<view
  class="{{classPrefix}} {{[inChat ? classPrefix + '--chatting' : '', _this.getFileTypeClass(inChat, files)]}}"
  style="{{_._style([style, customStyle])}}"
>
  <view class="{{classPrefix}}__left">
    <!-- 对话模式：图片横向滚动，文件纵向排列 -->
    <block wx:if="{{inChat}}">
      <!-- 图片横向滚动区域 -->
      <scroll-view wx:if="{{_this.hasImageFile(files)}}" class="{{classPrefix}}__scrollable scroll-x" scroll-x style="height: {{scrollViewHeight}}px">
        <block wx:for="{{files}}" wx:for-item="item" wx:for-index="index" wx:key="index">
          <view wx:if="{{item.fileType==='image'}}" class="{{classPrefix}}__files" bindtap="onFileWrapTap" data-index="{{index}}">
            <template is="image-item" data="{{item, index, classPrefix, removable, isSkyline, inChat}}" />
          </view>
        </block>
      </scroll-view>

      <!-- 非图片文件纵向排列 -->
      <view class="{{classPrefix}}__files-container">
        <block wx:for="{{files}}" wx:for-item="item" wx:for-index="index" wx:key="index">
          <view wx:if="{{item.fileType!=='image'}}" class="{{classPrefix}}__files" bindtap="onFileWrapTap" data-index="{{index}}">
            <template is="file-item" data="{{item, index, classPrefix, removable, isSkyline}}" />
          </view>
        </block>
      </view>
    </block>

    <!-- 非对话模式：所有文件横向滚动 -->
    <block wx:else>
      <scroll-view class="{{classPrefix}}__scrollable scroll-x" scroll-x style="height: {{scrollViewHeight}}px">
        <block wx:for="{{files}}" wx:for-item="item" wx:for-index="index" wx:key="index">
          <view class="{{classPrefix}}__files" bindtap="onFileWrapTap" data-index="{{index}}">
            <template wx:if="{{item.fileType==='image'}}" is="image-item" data="{{item, index, classPrefix, removable, isSkyline, inChat}}" />
            <template wx:else is="file-item" data="{{item, index, classPrefix, removable, isSkyline}}" />
          </view>
        </block>
      </scroll-view>
    </block>
  </view>
</view>
