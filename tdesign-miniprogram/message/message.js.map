{"version":3,"sources":["../src/message/message.ts"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["import { SuperComponent, wxComponent } from '../common/src/index';\nimport config from '../common/config';\nimport { MessageProps } from './message.interface';\nimport props from './props';\n\nconst { prefix } = config;\nconst name = `${prefix}-message`;\n\n// 展示动画持续时间\nconst SHOW_DURATION = 500;\n@wxComponent()\nexport default class Message extends SuperComponent {\n  externalClasses = [\n    't-class',\n    't-class-content',\n    't-class-icon',\n    't-class-action',\n    't-class-close-btn',\n  ];\n\n  options = {\n    styleIsolation: 'apply-shared' as const,\n    multipleSlots: true,\n  };\n\n  // 组件的对外属性\n  properties: MessageProps = { ...props } as unknown as MessageProps;\n\n  // 组件的内部数据\n  data = {\n    prefix,\n    classPrefix: name,\n    visible: false,\n    loop: -1,\n    animation: [],\n    showAnimation: [],\n    iconName: '',\n    wrapTop: -92,\n  };\n\n  observers = {\n    marquee(val) {\n      if (JSON.stringify(val) === '{}') {\n        this.setData({\n          marquee: {\n            speed: 50,\n            loop: -1,\n            delay: 5000,\n          },\n        });\n      }\n    },\n  };\n\n  /** 延时关闭句柄 */\n  closeTimeoutContext = 0;\n\n  /** 动画句柄 */\n  nextAnimationContext = 0;\n\n  resetAnimation = wx.createAnimation({\n    duration: 0,\n    timingFunction: 'linear',\n  });\n\n  // 入场动画\n  showAnimation = wx\n    .createAnimation({ duration: SHOW_DURATION, timingFunction: 'ease' })\n    .translateY(0)\n    .opacity(1)\n    .step()\n    .export();\n\n  // 出场动画\n  hideAnimation = wx\n    .createAnimation({ duration: SHOW_DURATION, timingFunction: 'ease' })\n    .translateY(this.data.wrapTop)\n    .opacity(0)\n    .step()\n    .export();\n\n  ready() {\n    this.memoInitalData();\n    this.setIcon();\n  }\n\n  /** 记录组件设置的项目 */\n  memoInitalData() {\n    this.initalData = {\n      ...this.properties,\n      ...this.data,\n    };\n  }\n\n  resetData(cb: () => void) {\n    this.setData({ ...this.initalData }, cb);\n  }\n\n  detached() {\n    this.clearMessageAnimation();\n  }\n\n  /** icon 值设置 */\n  setIcon(icon = this.properties.icon) {\n    // 使用空值\n    if (!icon) {\n      this.setData({ iconName: '' });\n      return;\n    }\n    // 固定值\n    if (typeof icon === 'string') {\n      this.setData({\n        iconName: `${icon}`,\n      });\n      return;\n    }\n\n    // 使用默认值\n    if (icon) {\n      let nextValue = 'notification';\n      const { theme } = this.properties;\n      const themeMessage = {\n        info: 'error-circle',\n        success: 'check-circle',\n        warning: 'error-circle',\n        error: 'error-circle',\n      };\n      nextValue = themeMessage[theme];\n      this.setData({ iconName: nextValue });\n    }\n  }\n\n  /** 检查是否需要开启一个新的动画循环 */\n  checkAnimation() {\n    const speeding = this.properties.marquee.speed;\n\n    if (!this.properties.marquee) {\n      return;\n    }\n\n    if (this.data.loop > 0) {\n      this.data.loop -= 1;\n    } else if (this.data.loop === 0) {\n      // 动画回到初始位置\n      this.setData({ animation: this.resetAnimation.translateX(0).step().export() });\n      return;\n    }\n\n    if (this.nextAnimationContext) {\n      this.clearMessageAnimation();\n    }\n\n    const warpID = `#${name}__text-wrap`;\n    const nodeID = `#${name}__text`;\n    Promise.all([this.queryWidth(nodeID), this.queryWidth(warpID)]).then(\n      ([nodeWidth, warpWidth]) => {\n        this.setData(\n          {\n            animation: this.resetAnimation.translateX(warpWidth).step().export(),\n          },\n          () => {\n            const durationTime = ((nodeWidth + warpWidth) / speeding) * 1000;\n            const nextAnimation = wx\n              .createAnimation({\n                // 默认50px/s\n                duration: durationTime,\n              })\n              .translateX(-nodeWidth)\n              .step()\n              .export();\n\n            // 这里就只能用 setTimeout/20, nextTick 没用\n            // 不用这个的话会出现reset动画没跑完就开始跑这个等的奇怪问题\n            setTimeout(() => {\n              this.nextAnimationContext = setTimeout(\n                this.checkAnimation.bind(this),\n                durationTime,\n              ) as unknown as number;\n\n              this.setData({ animation: nextAnimation });\n            }, 20);\n          },\n        );\n      },\n    );\n  }\n\n  /** 获取元素宽度 */\n  queryWidth(queryName: string): Promise<number> {\n    return new Promise((resolve) => {\n      this.createSelectorQuery()\n        .select(queryName)\n        .boundingClientRect(({ width }) => {\n          resolve(width);\n        })\n        .exec();\n    });\n  }\n\n  /** 获取元素长度 */\n  queryHeight(queryName: string): Promise<number> {\n    return new Promise((resolve) => {\n      this.createSelectorQuery()\n        .select(queryName)\n        .boundingClientRect(({ height }) => {\n          resolve(height);\n        })\n        .exec();\n    });\n  }\n\n  /** 清理动画循环 */\n  clearMessageAnimation() {\n    clearTimeout(this.nextAnimationContext);\n    this.nextAnimationContext = 0;\n  }\n\n  show() {\n    const { duration, icon } = this.properties;\n    this.setData({ visible: true, loop: this.properties.marquee.loop });\n    this.reset();\n    this.setIcon(icon);\n    this.checkAnimation();\n    if (duration && duration > 0) {\n      this.closeTimeoutContext = setTimeout(() => {\n        this.hide();\n        this.triggerEvent('durationEnd', { self: this });\n      }, duration) as unknown as number;\n    }\n\n    const wrapID = `#${name}`;\n    this.queryHeight(wrapID).then((wrapHeight) => {\n      this.setData({ showAnimation: this.showAnimation, wrapTop: -wrapHeight });\n    });\n  }\n\n  hide() {\n    this.reset();\n    this.setData({ showAnimation: this.hideAnimation });\n    setTimeout(() => {\n      this.setData({ visible: false, animation: [] });\n    }, SHOW_DURATION);\n  }\n\n  // 重置定时器\n  reset() {\n    if (this.nextAnimationContext) {\n      this.clearMessageAnimation();\n    }\n    clearTimeout(this.closeTimeoutContext);\n    this.closeTimeoutContext = 0;\n  }\n\n  handleClose() {\n    this.hide();\n    this.triggerEvent('closeBtnClick');\n  }\n\n  handleBtnClick() {\n    this.triggerEvent('actionBtnClick', { self: this });\n  }\n}\n"]}